# ğŸ—ï¸ HUMBUG Multiplayer Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER (React + TypeScript)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Room Lobby   â”‚  â”‚ Game Screen  â”‚  â”‚ Question Cardâ”‚  â”‚ Scoreboard  â”‚â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚             â”‚â”‚
â”‚  â”‚ - Create     â”‚  â”‚ - Answer     â”‚  â”‚ - Timer      â”‚  â”‚ - Lives     â”‚â”‚
â”‚  â”‚ - Join       â”‚  â”‚ - HUMBUG     â”‚  â”‚ - Reveal     â”‚  â”‚ - Passes    â”‚â”‚
â”‚  â”‚ - Pack List  â”‚  â”‚ - Turn Order â”‚  â”‚ - Fuzzy Hint â”‚  â”‚ - Eliminatedâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Polling Loop (Every 3 seconds)                        â”‚ â”‚
â”‚  â”‚  GET /api/rooms?action=state&roomId={uuid}                        â”‚ â”‚
â”‚  â”‚  Headers: If-None-Match: "version-123"                            â”‚ â”‚
â”‚  â”‚  â†’ 304 Not Modified (no changes) OR 200 OK (full state)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP/HTTPS
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API LAYER (Vercel Serverless Functions)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  /api/rooms.ts (Unified Multiplayer Endpoint)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                    â”‚â”‚
â”‚  â”‚  Query Parameter: ?action={action}                               â”‚â”‚
â”‚  â”‚                                                                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
â”‚  â”‚  â”‚   create     â”‚  â”‚     join     â”‚  â”‚    leave     â”‚           â”‚â”‚
â”‚  â”‚  â”‚ Generate codeâ”‚  â”‚ Check auth   â”‚  â”‚ Remove playerâ”‚           â”‚â”‚
â”‚  â”‚  â”‚ Create room  â”‚  â”‚ Add player   â”‚  â”‚ Reassign hostâ”‚           â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
â”‚  â”‚                                                                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
â”‚  â”‚  â”‚    start     â”‚  â”‚    state     â”‚  â”‚   answer     â”‚           â”‚â”‚
â”‚  â”‚  â”‚ Verify accessâ”‚  â”‚ ETag check   â”‚  â”‚ Fuzzy match  â”‚           â”‚â”‚
â”‚  â”‚  â”‚ Sample Qs    â”‚  â”‚ Return state â”‚  â”‚ Set pending  â”‚           â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
â”‚  â”‚                                                                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚â”‚
â”‚  â”‚  â”‚   humbug     â”‚  â”‚     next     â”‚  â”‚available-setsâ”‚           â”‚â”‚
â”‚  â”‚  â”‚ Challenge ansâ”‚  â”‚ Advance Q    â”‚  â”‚ Role-based   â”‚           â”‚â”‚
â”‚  â”‚  â”‚ Update lives â”‚  â”‚ Next turn    â”‚  â”‚ Pack list    â”‚           â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚â”‚
â”‚  â”‚                                                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Session Management:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Cookie: humbug_session (64-char hex)                              â”‚â”‚
â”‚  â”‚ HttpOnly: true, Secure: true, SameSite: lax                       â”‚â”‚
â”‚  â”‚ MaxAge: 7 days                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  JWT Authentication (Optional):                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Cookie: auth_token (JWT)                                           â”‚â”‚
â”‚  â”‚ Contains: userId, email, name, nickname, role                      â”‚â”‚
â”‚  â”‚ Used for: Profile nickname, Question pack access                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Rate Limiting (In-memory):                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Per IP: 120 requests/minute                                        â”‚â”‚
â”‚  â”‚ Window: 60 seconds                                                 â”‚â”‚
â”‚  â”‚ Headers: X-RateLimit-Limit, X-RateLimit-Remaining                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ SQL Queries
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                DATABASE LAYER (Neon PostgreSQL Serverless)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   game_rooms       â”‚  â”‚   room_players     â”‚  â”‚ game_sessions    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ id (UUID)          â”‚  â”‚ id (UUID)          â”‚  â”‚ id (UUID)        â”‚ â”‚
â”‚  â”‚ code (CHAR(6))     â”‚  â”‚ room_id (FK)       â”‚  â”‚ room_id (FK)     â”‚ â”‚
â”‚  â”‚ host_player_id     â”‚  â”‚ session_id         â”‚  â”‚ question_set_id  â”‚ â”‚
â”‚  â”‚ max_players        â”‚  â”‚ nickname           â”‚  â”‚ questions_ids[]  â”‚ â”‚
â”‚  â”‚ state              â”‚  â”‚ lives (INT)        â”‚  â”‚ current_index    â”‚ â”‚
â”‚  â”‚ state_version âœ¨   â”‚  â”‚ passes (INT)       â”‚  â”‚ current_turn_id  â”‚ â”‚
â”‚  â”‚ question_set_id    â”‚  â”‚ is_eliminated      â”‚  â”‚ pending_answer   â”‚ â”‚
â”‚  â”‚ created_at         â”‚  â”‚ join_order         â”‚  â”‚ started_at       â”‚ â”‚
â”‚  â”‚ expires_at         â”‚  â”‚ joined_at          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  player_answers    â”‚  â”‚   humbug_events    â”‚                        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
â”‚  â”‚ id (UUID)          â”‚  â”‚ id (SERIAL)        â”‚                        â”‚
â”‚  â”‚ session_id (FK)    â”‚  â”‚ room_id (FK)       â”‚                        â”‚
â”‚  â”‚ player_id (FK)     â”‚  â”‚ event_type         â”‚                        â”‚
â”‚  â”‚ question_id        â”‚  â”‚ player_id          â”‚                        â”‚
â”‚  â”‚ answer_text        â”‚  â”‚ data (JSONB)       â”‚                        â”‚
â”‚  â”‚ is_correct         â”‚  â”‚ created_at         â”‚                        â”‚
â”‚  â”‚ was_challenged     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚  â”‚ challenger_id      â”‚                                                 â”‚
â”‚  â”‚ challenge_success  â”‚                                                 â”‚
â”‚  â”‚ submitted_at       â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                          â”‚
â”‚  Existing Tables (Reused):                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚     questions      â”‚  â”‚  question_sets     â”‚                        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
â”‚  â”‚ id                 â”‚  â”‚ id                 â”‚                        â”‚
â”‚  â”‚ question_text_en   â”‚  â”‚ slug               â”‚                        â”‚
â”‚  â”‚ question_text_hu   â”‚  â”‚ name_en, name_hu   â”‚                        â”‚
â”‚  â”‚ category           â”‚  â”‚ access_level ğŸ”’    â”‚                        â”‚
â”‚  â”‚ question_set_id    â”‚  â”‚ question_count     â”‚                        â”‚
â”‚  â”‚ allowed_answers[]  â”‚  â”‚ display_order      â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DATA FLOW EXAMPLES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. CREATE ROOM FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client                     API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€POST /api/rooms?action=create                       â”‚
  â”‚  { maxPlayers: 10 }    â”‚                            â”‚
  â”‚                         â”œâ”€generateUniqueRoomCode()  â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€INSERT game_roomsâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  code: "INFOLE"           â”‚
  â”‚                         â”‚  state: "waiting"          â”‚
  â”‚                         â”‚  state_version: 0          â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€INSERT room_playersâ”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  nickname: "Host"          â”‚
  â”‚                         â”‚  lives: 3, passes: 0       â”‚
  â”‚                         â”‚  join_order: 0             â”‚
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€{ roomId, code }â”€â”€â”€â”¤                            â”‚
  â”‚                         â”‚                            â”‚


2. JOIN ROOM FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client                     API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€POST /api/rooms?action=join                         â”‚
  â”‚  { code: "INFOLE",     â”‚                            â”‚
  â”‚    nickname: "Player2" }â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€getAuthenticatedUser()    â”‚
  â”‚                         â”‚  (check JWT cookie)        â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT FROM game_roomsâ”€â”€â”€â”€>â”‚
  â”‚                         â”‚  WHERE code='INFOLE'       â”‚
  â”‚                         â”‚<â”€â”€â”€(room exists, joinable)â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€INSERT room_playersâ”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  session_id: "abc123..."   â”‚
  â”‚                         â”‚  nickname: "Player2"       â”‚
  â”‚                         â”‚  join_order: 1             â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_roomsâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  state_version: 1          â”‚
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€{ playerId,        â”¤                            â”‚
  â”‚       nickname,        â”‚                            â”‚
  â”‚       authenticated }â”€â”€â”¤                            â”‚


3. START GAME FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client                     API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€POST /api/rooms?action=start                        â”‚
  â”‚  { roomId, questionSetId: 2 }                       â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€getAuthenticatedUser()    â”‚
  â”‚                         â”‚  role: "premium"           â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€getAvailableQuestionSets("premium")
  â”‚                         â”‚<â”€â”€â”€SELECT WHERE access_levelâ”€â”€â”¤
  â”‚                         â”‚     IN ('free', 'premium')    â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€(verify access: âœ…)         â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT questionsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  FROM question_sets        â”‚
  â”‚                         â”‚  WHERE id=2 LIMIT 10       â”‚
  â”‚                         â”‚<â”€â”€â”€[Q1, Q2, Q3... Q10]â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€INSERT game_sessionsâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  questions_ids: [1,5,9...] â”‚
  â”‚                         â”‚  current_turn_player: P1   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_roomsâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  state: "in_progress"      â”‚
  â”‚                         â”‚  state_version: 2          â”‚
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€{ sessionId,       â”¤                            â”‚
  â”‚       questionCount }â”€â”€â”¤                            â”‚


4. POLLING STATE FLOW (ETag Optimization):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client                     API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€GET /api/rooms?action=state&roomId=...              â”‚
  â”‚  If-None-Match: "2"    â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT state_versionâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚<â”€â”€â”€current: 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€(version match: 304)      â”‚
  â”‚<â”€â”€â”€â”€HTTP 304â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  (No body, ~10 bytes)  â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚ [3 seconds later...]   â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”œâ”€GET /api/rooms?action=state&roomId=...              â”‚
  â”‚  If-None-Match: "2"    â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT state_versionâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚<â”€â”€â”€current: 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€(version changed!)        â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT room, playersâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”œâ”€SELECT session, questionâ”€â”€>â”‚
  â”‚                         â”œâ”€SELECT eventsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚<â”€â”€â”€full state dataâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€HTTP 200â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  { stateVersion: 5,    â”‚                            â”‚
  â”‚    data: {...} }       â”‚                            â”‚
  â”‚  (~5KB)                â”‚                            â”‚


5. ANSWER + HUMBUG FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Player1                    API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€POST /api/rooms?action=answer                       â”‚
  â”‚  { answer: "Wrong Answer" }                         â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT allowed_answersâ”€â”€â”€â”€>â”‚
  â”‚                         â”‚<â”€â”€â”€["Correct", "Answer"]â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€fuzzyMatchAnswer()        â”‚
  â”‚                         â”‚  (normalize, Levenshtein)  â”‚
  â”‚                         â”‚  Result: âŒ Not a match    â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€INSERT player_answersâ”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  is_correct: false         â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_sessionsâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  pending_answer_id: A123   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_roomsâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  state_version: 6          â”‚
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€{ answerId,        â”¤                            â”‚
  â”‚       canBeChallenged }â”¤                            â”‚
  â”‚                         â”‚                            â”‚

Player2                    API                        Database
  â”‚                         â”‚                            â”‚
  â”œâ”€POST /api/rooms?action=humbug                       â”‚
  â”‚  { answerId: A123 }    â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€SELECT player_answersâ”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚<â”€â”€â”€answer_text, is_correctâ”¤
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€(answer was WRONG!)       â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE room_playersâ”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  Player1.lives: 3â†’2        â”‚
  â”‚                         â”‚  Player2.passes: 0â†’1       â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE player_answersâ”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  was_challenged: true      â”‚
  â”‚                         â”‚  challenger_id: Player2    â”‚
  â”‚                         â”‚  challenge_successful: trueâ”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_sessionsâ”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  pending_answer_id: NULL   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€UPDATE game_roomsâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚  state_version: 7          â”‚
  â”‚                         â”‚                            â”‚
  â”‚<â”€â”€â”€â”€{ challengeSuccessful: true,                    â”‚
  â”‚       answererLostLife: true }                      â”‚


6. FUZZY MATCHING ALGORITHM:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User Answer: "Barcelone"
Correct Answers: ["Barcelona", "FC Barcelona"]

Step 1: Normalize
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"Barcelone"          â†’ "barcelone"
"Barcelona"          â†’ "barcelona"
"FC Barcelona"       â†’ "barcelona"  (remove "FC")

Step 2: Extract Key Words (>2 chars)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"barcelone"          â†’ ["barcelone"]
"barcelona"          â†’ ["barcelona"]

Step 3: Match with Levenshtein Distance
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"barcelone" vs "barcelona"
  b a r c e l o n e
b 0 1 2 3 4 5 6 7 8
a 1 0 1 2 3 4 5 6 7
r 2 1 0 1 2 3 4 5 6
c 3 2 1 0 1 2 3 4 5
e 4 3 2 1 0 1 2 3 4
l 5 4 3 2 1 0 1 2 3
o 6 5 4 3 2 1 0 1 2
n 7 6 5 4 3 2 1 0 1
a 8 7 6 5 4 3 2 1 0

Distance: 1 (substitute 'e' â†’ 'a')
Tolerance: â‰¤ 1 character difference
Result: âœ… MATCH!

Step 4: Calculate Overlap Ratio
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Matching words: 1
Total correct words: 1
Ratio: 1/1 = 100%
Threshold: â‰¥ 100% OR â‰¥ 75% for multi-word
Result: âœ… ACCEPT ANSWER!


KEY FEATURES HIGHLIGHTED:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¨ state_version: Incremented on every state change for ETag optimization
ğŸ”’ access_level: Role-based question pack access (free/premium/admin)
ğŸ“Š lives, passes: HUMBUG game mechanics (3 lives, earn passes)
ğŸ¯ pending_answer_id: Temporary storage for challengeable answers
ğŸ” fuzzyMatchAnswer(): Tolerant matching with Levenshtein distance
ğŸ” JWT auth_token: Optional authentication for premium features
ğŸª humbug_session: Guest play support without account
â±ï¸ expires_at: Auto-cleanup of old rooms (24h)
ğŸ“ humbug_events: Complete audit trail of all game actions
```

---

**Architecture Principles:**

1. **Stateless HTTP**: No WebSockets, pure REST API
2. **Serverless-First**: Optimized for Vercel's function model
3. **Bandwidth Efficient**: ETag 304 responses for unchanged state
4. **Action-Based Routing**: Single endpoint, 9 actions
5. **Role-Based Access**: Free/Premium/Admin tiers
6. **Guest-Friendly**: No authentication required
7. **Profile Integration**: Auto-populate from JWT when available
8. **Event Logging**: Full game history for debugging/analytics
9. **Security First**: HTTP-only cookies, rate limiting, input validation
10. **Performance Optimized**: Connection pooling, indexed queries, <50ms response
